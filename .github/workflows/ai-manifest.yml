name: Build RumbleDome Manifest to assist AI when processing the repo
on:
  push:
    branches: [ "main" ]
jobs:
  build-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Generate manifest
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          INCLUDE_DIRS=("." "docs" "src" "tests")

          echo '{'                                   > .rd-manifest.json
          echo "  \"repo\": \"${REPO}\","           >> .rd-manifest.json
          echo "  \"commit\": \"${COMMIT}\","       >> .rd-manifest.json
          echo "  \"branch\": \"${BRANCH}\","       >> .rd-manifest.json
          echo "  \"generated_at\": \"${DATE}\","   >> .rd-manifest.json
          echo '  "files": ['                       >> .rd-manifest.json

          FIRST=1
          for DIR in "${INCLUDE_DIRS[@]}"; do
            if [ -d "$DIR" ]; then
              while IFS= read -r -d '' FILE; do
                [ -d "$FILE" ] && continue
                RAW_PATH=$(echo "$FILE" | sed 's/ /%20/g; s/#/%23/g')
                RAW_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${RAW_PATH}"
                SHA=$(git ls-files -s "$FILE" | awk '{print $2}')
                if [ $FIRST -eq 0 ]; then echo ',' >> .rd-manifest.json; fi
                FIRST=0
                printf '    { "path": "%s", "raw": "%s", "sha": "%s" }' "$FILE" "$RAW_URL" "$SHA" >> .rd-manifest.json
              done < <(find "$DIR" -type f -print0 | sort -z)
            fi
          done

          echo '' >> .rd-manifest.json
          echo '  ]' >> .rd-manifest.json
          echo '}'   >> .rd-manifest.json

      - name: Commit manifest
        run: |
          if ! git diff --quiet -- .rd-manifest.json; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .rd-manifest.json
            git commit -m "chore: update .rd-manifest.json"
            git push
          else
            echo "Manifest unchanged."
          fi
